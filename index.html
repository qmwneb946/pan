<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub ç½‘ç›˜</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.js"></script>
  <style>
    body {
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f8f9fa;
    }
    .file-list {
      list-style: none;
      padding: 0;
    }
    .file-list li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .file-list li:last-child {
      border-bottom: none;
    }
    .file-list i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    .breadcrumb-item a {
      text-decoration: none;
      color: #0d6efd;
    }
    .breadcrumb-item.active {
      color: #6c757d;
    }
    .download-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
    }
    .file-info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }
    .file-preview img, .file-preview video, .file-preview audio {
      max-width: 100%;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center my-4">ğŸ“‚ æˆ‘çš„ GitHub ç½‘ç›˜</h2>
    <div class="text-center my-4">
      <a href="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment">
        <img src="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment/badge.svg" alt="pages-build-deployment">
      </a>
    </div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="breadcrumb">
        <li class="breadcrumb-item active">æ ¹ç›®å½•</li>
      </ol>
    </nav>
    <div class="card">
      <div class="card-body">
        <ul class="file-list" id="file-list">æ­£åœ¨åŠ è½½æ–‡ä»¶...</ul>
      </div>
    </div>
  </div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">é¢„è§ˆ: <span id="previewFilename"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
        </div>
        <div class="modal-body">
          <div id="monaco-container" style="width:100%;height:80vh;border:1px solid #ddd;"></div>
          <div id="media-container" class="file-preview"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const repo = "qmwneb946/pan"; // GitHub repo
    const branch = "main"; // Branch
    let currentPath = "files"; // Default folder
    let cache = {}; // Cache for file data
    let editor = null; // Monaco editor instance

    // Define file extensions for preview
    const previewExtensions = ["txt", "cpp", "c", "h", "py", "js", "json", "html", "css", "md", "java", "go", "rs", "csv", "mp4"];
    const imageExtensions = ["jpg", "jpeg", "png", "gif", "bmp"];
    const videoExtensions = ["mp4", "webm", "ogg"];
    const audioExtensions = ["mp3", "wav", "ogg"];

    async function fetchFiles(path) {
      console.log(`Fetching files from path: ${path}`);
      updateBreadcrumb(path);
      if (cache[path]) {
        renderFiles(cache[path], path);
        return;
      }
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      try {
        let response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch files: ${response.statusText}`);
        }
        let files = await response.json();
        console.log('Files fetched:', files);
        cache[path] = files;
        renderFiles(files, path);
      } catch (error) {
        console.error('Error fetching files:', error);
        document.getElementById("file-list").innerText = "æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨";
      }
    }

    function renderFiles(files, path) {
      let list = document.getElementById("file-list");
      list.innerHTML = "";

      files.sort((a, b) => {
        if (a.type === b.type) {
          return a.name.localeCompare(b.name);
        }
        return a.type === 'dir' ? -1 : 1;
      });

      files.forEach(file => {
        let li = document.createElement("li");
        let fileInfo = document.createElement("div");
        fileInfo.className = "file-info";

        let link = document.createElement("a");
        link.style = "text-decoration: none; color: inherit; flex-grow: 1;";
        if (file.type === "dir") {
          link.href = "#";
          link.onclick = (e) => {
            e.preventDefault();
            currentPath = file.path;
            fetchFiles(file.path);
          };
          link.innerHTML = `<i class="fas fa-folder text-warning"></i> ${file.name}`;
        } else {
          let ext = file.name.split('.').pop().toLowerCase();
          let size = formatFileSize(file.size);
          let modifiedDate = file.commit ? new Date(file.commit.committer.date).toLocaleDateString() : "æœªçŸ¥";
          if (previewExtensions.includes(ext)) {
            link.href = "#";
            link.onclick = (e) => {
              e.preventDefault();
              previewFile(file);
            };
            link.innerHTML = `<i class="fas fa-file-alt text-primary"></i> ${file.name} <span class="text-muted">(${size})</span> <span class="text-muted">æœ€åä¿®æ”¹: ${modifiedDate}</span>`;
          } else {
            link.href = `https://pan.qmwneb946.us.kg/${file.path}`;
            link.target = "_blank";
            link.innerHTML = `<i class="fas fa-file text-secondary"></i> ${file.name} <span class="text-muted">(${size})</span> <span class="text-muted">æœ€åä¿®æ”¹: ${modifiedDate}</span>`;
          }
        }

        fileInfo.appendChild(link);
        li.appendChild(fileInfo);

        if (file.type !== "dir") {
          let downloadButton = document.createElement("a");
          downloadButton.href = `https://pan.qmwneb946.us.kg/${file.path}`;
          downloadButton.className = "btn btn-sm btn-outline-primary download-btn";
          downloadButton.innerHTML = '<i class="fas fa-download"></i>';
          downloadButton.download = file.name;
          li.appendChild(downloadButton);
        }

        list.appendChild(li);
      });
    }

    function updateBreadcrumb(path) {
      const breadcrumb = document.getElementById("breadcrumb");
      breadcrumb.innerHTML = "";
      const parts = path.split("/");
      let accumulatedPath = "";
      const rootItem = document.createElement("li");
      rootItem.className = "breadcrumb-item";
      rootItem.innerHTML = `<a href="#" onclick="navigateToRoot(event)">æ ¹ç›®å½•</a>`;
      breadcrumb.appendChild(rootItem);

      parts.forEach((part, index) => {
        accumulatedPath += (index === 0 ? part : "/" + part);
        const li = document.createElement("li");
        li.className = "breadcrumb-item";
        if (index === parts.length - 1) {
          li.classList.add("active");
          li.setAttribute("aria-current", "page");
          li.textContent = part;
        } else {
          li.innerHTML = `<a href="#" onclick="navigateBreadcrumb(event, '${accumulatedPath}')">${part}</a>`;
        }
        breadcrumb.appendChild(li);
      });
    }

    function navigateBreadcrumb(e, path) {
      e.preventDefault();
      currentPath = path;
      fetchFiles(path);
    }

    function navigateToRoot(e) {
      e.preventDefault();
      currentPath = "files";
      fetchFiles(currentPath);
    }

    async function previewFile(file) {
      console.log(`Previewing file: ${file.name}`);
      document.getElementById("previewFilename").textContent = file.name;
      const container = document.getElementById("monaco-container");
      const mediaContainer = document.getElementById("media-container");
      container.innerHTML = "åŠ è½½ä¸­...";
      mediaContainer.innerHTML = "";
      try {
        let response = await fetch(file.download_url.replace("github.com", "pan.qmwneb946.us.kg"));
        if (!response.ok) {
          throw new Error(`Failed to load file: ${response.statusText}`);
        }
        let content = await response.text();
        let ext = file.name.split('.').pop().toLowerCase();
        let language = getLanguageFromFileName(file.name);
        let modalEl = document.getElementById('previewModal');
        let modal = new bootstrap.Modal(modalEl);
        modal.show();

        if (imageExtensions.includes(ext)) {
          mediaContainer.innerHTML = `<img src="${file.download_url}" class="img-fluid" alt="${file.name}">`;
        } else if (videoExtensions.includes(ext)) {
          mediaContainer.innerHTML = `<video controls class="w-100"><source src="${file.download_url}" type="video/${ext}"></video>`;
        } else if (audioExtensions.includes(ext)) {
          mediaContainer.innerHTML = `<audio controls class="w-100"><source src="${file.download_url}" type="audio/${ext}"></audio>`;
        } else {
          loadMonacoEditor(content, language);
        }
      } catch (error) {
        console.error('Error loading file content:', error);
        container.innerText = "æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹";
      }
    }

    function getLanguageFromFileName(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      switch(ext) {
        case "cpp":
        case "c":
        case "h":
          return "cpp";
        case "py":
          return "python";
        case "js":
          return "javascript";
        case "json":
          return "json";
        case "html":
          return "html";
        case "css":
          return "css";
        case "md":
          return "markdown";
        case "java":
          return "java";
        case "go":
          return "go";
        case "rs":
          return "rust";
        case "csv":
          return "csv";
        default:
          return "plaintext";
      }
    }

    function loadMonacoEditor(content, language) {
      console.log("Loading Monaco editor...");
      if (editor) {
        editor.dispose();
      }
      const container = document.getElementById("monaco-container");
      container.innerHTML = "";
      require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' } });
      require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(container, {
          value: content,
          language: language,
          theme: "vs-light",
          automaticLayout: true,
          readOnly: true,
          minimap: { enabled: false }
        });
        console.log("Monaco editor loaded successfully!");
      });
    }

    function formatFileSize(size) {
      const units = ["B", "KB", "MB", "GB", "TB"];
      let unitIndex = 0;
      let formattedSize = size;
      while (formattedSize >= 1024 && unitIndex < units.length - 1) {
        formattedSize /= 1024;
        unitIndex++;
      }
      return `${formattedSize.toFixed(1)} ${units[unitIndex]}`;
    }

    fetchFiles(currentPath);
  </script>
  <div class="text-center my-4">
    <p>å¦‚æœä¸‹è½½/é¢„è§ˆå¤±è´¥ï¼Œè¯·ç¡®ä¿ä¸Šé¢çš„å›¾æ ‡ä¸ºç»¿è‰²ã€‚</p>
  </div>
</body>
</html>
