<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub 网盘</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.js"></script>
  
  <!-- 引入第三方库 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.cjs.min.js"></script>
  
  <style>
    body {
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f8f9fa;
    }
    .file-list {
      list-style: none;
      padding: 0;
    }
    .file-list li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .file-list li:last-child {
      border-bottom: none;
    }
    .file-list i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    .breadcrumb-item a {
      text-decoration: none;
      color: #0d6efd;
    }
    .breadcrumb-item.active {
      color: #6c757d;
    }
    .download-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
    }
    .file-info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }
    .progress-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center my-4">📂 我的 GitHub 网盘</h2>
    <div class="text-center my-4">
      <a href="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment">
        <img src="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment/badge.svg" alt="pages-build-deployment">
      </a>
    </div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="breadcrumb">
        <li class="breadcrumb-item active">根目录</li>
      </ol>
    </nav>
    <div class="card">
      <div class="card-body">
        <ul class="file-list" id="file-list">正在加载文件...</ul>
        <div class="progress-container">
          <p id="progress-status">加载中... (0/0)</p>
          <div class="progress">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">预览: <span id="previewFilename"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <div id="monaco-container" style="width:100%;height:80vh;border:1px solid #ddd;"></div>
          <div id="file-preview-container" style="width:100%;height:80vh;"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const repo = "qmwneb946/pan"; 
    const branch = "main"; 
    let currentPath = "files"; 
    let cache = {}; 
    let editor = null; 

    const previewExtensions = ["txt", "cpp", "c", "h", "py", "js", "json", "html", "css", "md", "java", "go", "rs", "csv", "xlsx", "docx"];

    // 初始化 Monaco Editor
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' } });

    async function fetchFiles(path) {
      updateBreadcrumb(path);
      if (cache[path]) {
        renderFiles(cache[path], path);
        return;
      }
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      try {
        const response = await fetch(url);
        const files = await response.json();
        cache[path] = files;
        renderFiles(files, path);
      } catch (error) {
        console.error('Error fetching files:', error);
        document.getElementById("file-list").innerText = "无法加载文件列表";
      }
    }

    function updateBreadcrumb(path) {
      const breadcrumb = document.getElementById("breadcrumb");
      breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="navigateToRoot(event)">根目录</a></li>';
      const parts = path.split("/");
      
      parts.forEach((part, index) => {
        if (!part) return;
        const li = document.createElement("li");
        li.className = "breadcrumb-item" + (index === parts.length - 1 ? " active" : "");
        if (index < parts.length - 1) {
          li.innerHTML = `<a href="#" onclick="navigateBreadcrumb(event, '${parts.slice(0, index+1).join('/')}')">${part}</a>`;
        } else {
          li.textContent = part;
        }
        breadcrumb.appendChild(li);
      });
    }

    function navigateToRoot(event) {
      event.preventDefault();
      currentPath = "files";
      fetchFiles(currentPath);
    }

    function navigateBreadcrumb(event, path) {
      event.preventDefault();
      currentPath = path;
      fetchFiles(path);
    }

    async function renderFiles(files, path) {
      const list = document.getElementById("file-list");
      list.innerHTML = "";
      const progressBar = document.getElementById("progress-bar");
      const progressStatus = document.getElementById("progress-status");
      const totalFiles = files.length;
      let processedFiles = 0;

      for (const file of files) {
        const li = createFileItem(file);
        list.appendChild(li);
        
        processedFiles++;
        progressBar.style.width = `${(processedFiles/totalFiles)*100}%`;
        progressStatus.textContent = `加载中... (${processedFiles}/${totalFiles})`;
        await new Promise(resolve => setTimeout(resolve, 5)); // 让UI更新
      }
    }

    function createFileItem(file) {
      const li = document.createElement("li");
      const modifiedDate = new Date(file.updated_at).toLocaleDateString();
      const size = formatFileSize(file.size);
      const ext = file.name.split('.').pop().toLowerCase();

      li.innerHTML = `
        <div class="file-info">
          <a href="#" class="${file.type === 'dir' ? 'folder' : 'file'}">
            <i class="fas ${file.type === 'dir' ? 'fa-folder text-warning' : 'fa-file-alt text-primary'}"></i>
            ${file.name}
            <span class="text-muted">(${size})</span>
            <span class="text-muted">最后修改: ${modifiedDate}</span>
          </a>
          ${file.type !== 'dir' ? `
            <a href="https://raw.githubusercontent.com/${repo}/${branch}/${file.path}" 
               class="btn btn-sm btn-outline-primary download-btn"
               download="${file.name}">
              <i class="fas fa-download"></i>
            </a>` : ''}
        </div>
      `;

      if (file.type === 'dir') {
        li.querySelector('a').addEventListener('click', (e) => {
          e.preventDefault();
          currentPath = file.path;
          fetchFiles(file.path);
        });
      } else if (previewExtensions.includes(ext)) {
        li.querySelector('a').addEventListener('click', (e) => {
          e.preventDefault();
          previewFile(file);
        });
      }

      return li;
    }

    async function previewFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      const previewTypes = {
        xlsx: previewExcelCsv,
        csv: previewExcelCsv,
        docx: previewDocx,
        pptx: previewPptx
      };

      try {
        const response = await fetch(`https://raw.githubusercontent.com/${repo}/${branch}/${file.path}`);
        const content = ext in previewTypes ? 
          await response.arrayBuffer() : 
          await response.text();

        document.getElementById("previewFilename").textContent = file.name;
        if (previewTypes[ext]) {
          previewTypes[ext](content, ext);
        } else {
          previewText(content, ext);
        }

        new bootstrap.Modal(document.getElementById('previewModal')).show();
      } catch (error) {
        console.error('Error loading file:', error);
        document.getElementById("file-preview-container").innerHTML = "无法加载文件内容";
      }
    }

    function previewExcelCsv(content, ext) {
      const wb = XLSX.read(content, { type: 'array' });
      const html = XLSX.utils.sheet_to_html(wb.Sheets[wb.SheetNames[0]]);
      document.getElementById("file-preview-container").innerHTML = html;
    }

    async function previewDocx(content) {
      try {
        const { value } = await mammoth.convertToHtml({ arrayBuffer: content });
        document.getElementById("file-preview-container").innerHTML = value;
      } catch (error) {
        document.getElementById("file-preview-container").innerHTML = "无法解析DOCX文件";
      }
    }

    function previewPptx() {
      document.getElementById("file-preview-container").innerHTML = "暂不支持PPTX文件预览";
    }

    function previewText(content, ext) {
      const container = document.getElementById("file-preview-container");
      const monacoContainer = document.getElementById("monaco-container");
      
      container.style.display = 'none';
      monacoContainer.style.display = 'block';

      if (editor) editor.dispose();
      
      require(['vs/editor/editor.main'], () => {
        editor = monaco.editor.create(monacoContainer, {
          value: content,
          language: getLanguage(ext),
          readOnly: true,
          theme: 'vs-light',
          automaticLayout: true
        });
      });
    }

    function getLanguage(ext) {
      const languages = {
        'js': 'javascript', 'py': 'python', 'html': 'html', 'css': 'css',
        'json': 'json', 'md': 'markdown', 'java': 'java', 'cpp': 'cpp',
        'c': 'c', 'h': 'cpp', 'go': 'go', 'rs': 'rust'
      };
      return languages[ext] || 'plaintext';
    }

    function formatFileSize(bytes) {
      const units = ['B', 'KB', 'MB', 'GB'];
      let size = bytes;
      for (const unit of units) {
        if (size < 1024) return `${size.toFixed(1)} ${unit}`;
        size /= 1024;
      }
      return `${size.toFixed(1)} GB`;
    }

    // 初始化
    document.getElementById('previewModal').addEventListener('hidden.bs.modal', () => {
      if (editor) {
        editor.dispose();
        editor = null;
      }
    });

    fetchFiles(currentPath);
  </script>
</body>
</html>
