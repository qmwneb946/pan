<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub ç½‘ç›˜</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.js"></script>
  
  <!-- å¼•å…¥ç¬¬ä¸‰æ–¹åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.cjs.min.js"></script>
  
  <style>
    body {
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f8f9fa;
    }
    .file-list {
      list-style: none;
      padding: 0;
    }
    .file-list li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .file-list li:last-child {
      border-bottom: none;
    }
    .file-list i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    .breadcrumb-item a {
      text-decoration: none;
      color: #0d6efd;
    }
    .breadcrumb-item.active {
      color: #6c757d;
    }
    .download-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
    }
    .file-info {
      display: flex;
      align-items: center;
      flex-grow: 1;
    }
    .progress-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center my-4">ğŸ“‚ æˆ‘çš„ GitHub ç½‘ç›˜</h2>
    <div class="text-center my-4">
      <a href="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment">
        <img src="https://github.com/qmwneb946/pan/actions/workflows/pages/pages-build-deployment/badge.svg" alt="pages-build-deployment">
      </a>
    </div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="breadcrumb">
        <li class="breadcrumb-item active">æ ¹ç›®å½•</li>
      </ol>
    </nav>
    <div class="card">
      <div class="card-body">
        <ul class="file-list" id="file-list">æ­£åœ¨åŠ è½½æ–‡ä»¶...</ul>
        <div class="progress-container">
          <p id="progress-status">åŠ è½½ä¸­... (0/0)</p>
          <div class="progress">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">é¢„è§ˆ: <span id="previewFilename"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
        </div>
        <div class="modal-body">
          <div id="monaco-container" style="width:100%;height:80vh;border:1px solid #ddd;"></div>
          <div id="file-preview-container" style="width:100%;height:80vh;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const repo = "qmwneb946/pan"; 
    const branch = "main"; 
    let currentPath = "files"; 
    let cache = {}; 
    let editor = null; 

    const previewExtensions = ["txt", "cpp", "c", "h", "py", "js", "json", "html", "css", "md", "java", "go", "rs", "csv", "mp4", "xlsx", "csv", "docx", "pptx"];

    async function fetchFiles(path) {
      console.log(`Fetching files from path: ${path}`);
      updateBreadcrumb(path);
      if (cache[path]) {
        renderFiles(cache[path], path);
        return;
      }
      const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`;
      try {
        let response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch files: ${response.statusText}`);
        }
        let files = await response.json();
        console.log('Files fetched:', files);
        cache[path] = files;
        renderFiles(files, path);
      } catch (error) {
        console.error('Error fetching files:', error);
        document.getElementById("file-list").innerText = "æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨";
      }
    }

    function updateBreadcrumb(path) {
      const breadcrumb = document.getElementById("breadcrumb");
      breadcrumb.innerHTML = "";
      const parts = path.split("/");
      let accumulatedPath = "";
      const rootItem = document.createElement("li");
      rootItem.className = "breadcrumb-item";
      if (parts[0] === "files") {
        rootItem.innerHTML = `<a href="#" onclick="navigateToRoot(event)">æ ¹ç›®å½•</a>`;
      } else {
        rootItem.textContent = "æ ¹ç›®å½•";
      }
      breadcrumb.appendChild(rootItem);

      parts.forEach((part, index) => {
        accumulatedPath += (index === 0 ? part : "/" + part);
        const li = document.createElement("li");
        li.className = "breadcrumb-item";
        if (index === parts.length - 1) {
          li.classList.add("active");
          li.setAttribute("aria-current", "page");
          li.textContent = part;
        } else {
          li.innerHTML = `<a href="#" onclick="navigateBreadcrumb(event, '${accumulatedPath}')">${part}</a>`;
        }
        breadcrumb.appendChild(li);
      });
    }

    async function renderFiles(files, path) {
      let list = document.getElementById("file-list");
      list.innerHTML = "";
      let totalFiles = files.length;
      let processedFiles = 0;
      
      // åˆå§‹åŒ–è¿›åº¦æ¡å’Œè¿›åº¦çŠ¶æ€
      let progressBar = document.getElementById("progress-bar");
      let progressStatus = document.getElementById("progress-status");
      progressBar.style.width = "0%";
      progressStatus.innerText = `åŠ è½½ä¸­... (0/${totalFiles})`;
      
      const promises = files.map(async (file, index) => {
        let li = document.createElement("li");
        let fileInfo = document.createElement("div");
        fileInfo.className = "file-info";

        let link = document.createElement("a");
        link.style = "text-decoration: none; color: inherit; flex-grow: 1;";
        if (file.type === "dir") {
          link.href = "#";
          link.onclick = (e) => {
            e.preventDefault();
            currentPath = file.path;
            fetchFiles(file.path);
          };
          link.innerHTML = `<i class="fas fa-folder text-warning"></i> ${file.name}`;
        } else {
          let ext = file.name.split('.').pop().toLowerCase();
          let size = formatFileSize(file.size);
          let modifiedDate = await getFileModifiedDate(file);
          if (previewExtensions.includes(ext)) {
            link.href = "#";
            link.onclick = (e) => {
              e.preventDefault();
              previewFile(file);
            };
            link.innerHTML = `<i class="fas fa-file-alt text-primary"></i> ${file.name} <span class="text-muted">(${size})</span> <span class="text-muted">æœ€åä¿®æ”¹: ${modifiedDate}</span>`;
          } else {
            link.href = `https://pan.qmwneb946.us.kg/${file.path}`;
            link.target = "_blank";
            link.innerHTML = `<i class="fas fa-file text-secondary"></i> ${file.name} <span class="text-muted">(${size})</span> <span class="text-muted">æœ€åä¿®æ”¹: ${modifiedDate}</span>`;
          }
        }

        fileInfo.appendChild(link);
        li.appendChild(fileInfo);

        // ä»…å¯¹æ–‡ä»¶æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼Œå¯¹æ–‡ä»¶å¤¹ä¸æ·»åŠ 
        if (file.type !== "dir") {
          let downloadButton = document.createElement("a");
          downloadButton.href = `https://pan.qmwneb946.us.kg/${file.path}`;
          downloadButton.className = "btn btn-sm btn-outline-primary download-btn";
          downloadButton.innerHTML = '<i class="fas fa-download"></i>';
          downloadButton.download = file.name;
          li.appendChild(downloadButton);
        }

        list.appendChild(li);
        
        // æ›´æ–°è¿›åº¦æ¡
        processedFiles++;
        let progress = (processedFiles / totalFiles) * 100;
        progressBar.style.width = `${progress}%`;
        progressStatus.innerText = `åŠ è½½ä¸­... (${processedFiles}/${totalFiles})`;
      });

      await Promise.all(promises); // ç­‰å¾…æ‰€æœ‰å¼‚æ­¥è¯·æ±‚å®Œæˆ
    }

    async function previewFile(file) {
      console.log(`Previewing file: ${file.name}`);
      document.getElementById("previewFilename").textContent = file.name;
      const container = document.getElementById("file-preview-container");
      container.innerHTML = "åŠ è½½ä¸­...";

      try {
        let response = await fetch(`https://pan.qmwneb946.us.kg/${file.path}`);
        if (!response.ok) {
          throw new Error(`Failed to load file: ${response.statusText}`);
        }
        let content = await response.text();

        // æ ¹æ®æ–‡ä»¶ç±»å‹è°ƒç”¨ç›¸åº”çš„è§£ææ–¹æ³•
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === "xlsx" || ext === "csv") {
          previewExcelCsv(content);
        } else if (ext === "docx") {
          previewDocx(content);
        } else if (ext === "pptx") {
          previewPptx(content);
        } else {
          previewText(content, ext);
        }

        let modalEl = document.getElementById('previewModal');
        let modal = new bootstrap.Modal(modalEl);
        modal.show();

      } catch (error) {
        console.error('Error loading file content:', error);
        container.innerText = "æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹";
      }
    }

    // é¢„è§ˆ Excel å’Œ CSV æ–‡ä»¶
    function previewExcelCsv(content) {
      let container = document.getElementById("file-preview-container");
      const wb = XLSX.read(content, { type: 'binary' });
      const sheetName = wb.SheetNames[0];
      const worksheet = wb.Sheets[sheetName];
      const html = XLSX.utils.sheet_to_html(worksheet);
      container.innerHTML = html;
    }

    // é¢„è§ˆ Word æ–‡ä»¶ (DOCX)
    function previewDocx(content) {
      let container = document.getElementById("file-preview-container");
      mammoth.convertToHtml({ arrayBuffer: content })
        .then(function(result) {
          container.innerHTML = result.value;
        })
        .catch(function(err) {
          console.log(err);
          container.innerText = "æ— æ³•è§£æ DOCX æ–‡ä»¶";
        });
    }

    // é¢„è§ˆ PPTX æ–‡ä»¶
    function previewPptx(content) {
      let container = document.getElementById("file-preview-container");
      const pptx = new PptxGenJS();
      pptx.load(content);
      pptx.getSlide(1).then((slide) => {
        container.innerHTML = slide;
      }).catch((err) => {
        console.log(err);
        container.innerText = "æ— æ³•è§£æ PPTX æ–‡ä»¶";
      });
    }

    // é¢„è§ˆæ–‡æœ¬æ–‡ä»¶
    function previewText(content, ext) {
      let container = document.getElementById("file-preview-container");
      container.innerText = content;
    }

    function formatFileSize(size) {
      const units = ["B", "KB", "MB", "GB", "TB"];
      let unitIndex = 0;
      let formattedSize = size;
      while (formattedSize >= 1024 && unitIndex < units.length - 1) {
        formattedSize /= 1024;
        unitIndex++;
      }
      return `${formattedSize.toFixed(1)} ${units[unitIndex]}`;
    }

    fetchFiles(currentPath);
  </script>
</body>
</html>
